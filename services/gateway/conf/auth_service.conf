location = @auth {
    proxy_pass http://auth_service/auth;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
}
location = /identity {
    limit_except get patch { deny all; }
    auth_request @auth;
    auth_request_set $authorization $upstream_http_authorization;

    proxy_set_header Authorization $authorization;
    proxy_pass http://auth_service;
}
location = /login {
    limit_except post { deny all; }

    proxy_pass http://auth_service;
}
location = /users {
    limit_except get post { deny all; }
    auth_request @auth;
    auth_request_set $authorization $upstream_http_authorization;

    proxy_set_header Authorization $authorization;
    proxy_pass http://auth_service;
}
location ~ ^/users/[^/]+$ {
    limit_except get patch delete { deny all; }
    auth_request @auth;
    auth_request_set $authorization $upstream_http_authorization;

    proxy_set_header Authorization $authorization;
    proxy_pass http://auth_service;
}
location ~ ^/users/[^/]+/roles/[^/]+/$ {
    limit_except put delete { deny all; }
    auth_request @auth;
    auth_request_set $authorization $upstream_http_authorization;

    proxy_set_header Authorization $authorization;
    proxy_pass http://auth_service;
}