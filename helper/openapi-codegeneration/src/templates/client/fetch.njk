/**
 * This file was automatically generated by openapi-codegeneration.
 * MOVE FILE BEFORE MODIFYING IT! OTHERWISE IT WILL BE OVERWRITTEN
 * BY SUBSEQUENT CODE-GENERATION!
 */
import {
    HttpMethods,
    ResponseData,
    FetchError
} from "./types"
import * as node_fetch from "node-fetch"

async function parseResponse(response: node_fetch.Response): Promise<ResponseData> {
    let text = null
    try {
        text = await response.text()
        const json = JSON.parse(text)
        return { status: response.status, body: json }
    } catch {
        return { status: response.status, body: text }
    }
}

export async function fetch<P,B,R extends ResponseData>(
    url: string, 
    method: HttpMethods, 
    parameters: P, 
    body: B, 
    validateInput: (parameters: P, body: B) => boolean,
    validateOutput: (response: ResponseData) => boolean
): Promise<R | FetchError> {
    if (!validateInput(parameters, body)) {
        return {
            type: "validation",
            error: "Request validation failed!"
        }
    }
    const raw_response = await node_fetch.default(url, {
        method: method,
        body: JSON.stringify(body),
        headers: body ? { 'Content-Type': 'application/json' } : undefined
    })
    const response = await parseResponse(raw_response)
    if (!validateOutput(response)) {
        return {
            type: "validation",
            error: "Response validation failed!",
            response: response
        }
    }
    return response as R
}